<Window x:Class="EnvironmentSpanner.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:EnvironmentSpanner"
        xmlns:ui="http://schemas.modernwpf.com/2019"
        xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
        mc:Ignorable="d"
        Title="Environment Variable Editor" MinWidth="600" MinHeight="400"
        ui:WindowHelper.UseModernWindowStyle="True"
        Icon="{StaticResource AppIcon}">
    <Window.Resources>
        <Style TargetType="DataGridCell" x:Key="ValueColumnCellStyle">
            <Setter Property="ContextMenu">
                <Setter.Value>
                    <ContextMenu>
                        <MenuItem Header="Edit List Values..." 
                                  Command="{Binding OpenListEditorCommand}"
                                  Visibility="{Binding IsListValue, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                    </ContextMenu>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Busy Indicator Overlay -->
        <Border Grid.RowSpan="2"
                Background="#80000000"
                Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}"
                Panel.ZIndex="1000">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <ui:ProgressRing IsActive="True" 
                                 Width="60" 
                                 Height="60"
                                 Foreground="White"/>
                <TextBlock Text="Loading..." 
                           Foreground="White" 
                           FontSize="16"
                           Margin="0,15,0,0"
                           HorizontalAlignment="Center"/>
            </StackPanel>
        </Border>

        <TabControl Grid.Row="0" SelectedIndex="{Binding SelectedTabIndex, Mode=TwoWay}">
            <TabItem Header="User Environment Variables">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="5">
                        <Button Content="Add Variable" Command="{Binding AddVariableCommand}" 
                                Margin="0,0,5,0" Padding="10,5"/>
                    </StackPanel>
                    <DataGrid Grid.Row="1" ItemsSource="{Binding UserVariables}" 
                              AutoGenerateColumns="False" 
                              CanUserAddRows="False"
                              CanUserDeleteRows="False"
                              SelectionMode="Single"
                              GridLinesVisibility="Horizontal"
                              HeadersVisibility="Column"
                              Margin="5">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Name" Binding="{Binding Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                Width="*" IsReadOnly="False"/>
                            <DataGridTemplateColumn Header="Value" Width="2*"
                                                    CellStyle="{StaticResource ValueColumnCellStyle}">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Border Padding="8,4" VerticalAlignment="Center">
                                            <TextBlock Text="{Binding Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                       TextWrapping="Wrap"
                                                       TextTrimming="CharacterEllipsis"
                                                       MaxHeight="100"
                                                       VerticalAlignment="Center"
                                                       IsEnabled="{Binding CanEdit}"
                                                       ToolTip="{Binding Value}"/>
                                        </Border>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                                <DataGridTemplateColumn.CellEditingTemplate>
                                    <DataTemplate>
                                        <TextBox Text="{Binding Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                 IsReadOnly="{Binding IsReadOnly}"
                                                 Padding="8,4"
                                                 VerticalContentAlignment="Center"
                                                 TextWrapping="Wrap"
                                                 AcceptsReturn="True"
                                                 MaxHeight="200"
                                                 VerticalScrollBarVisibility="Auto"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellEditingTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTemplateColumn Header="Actions" Width="Auto">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Button Content="Delete" Command="{Binding DeleteCommand}" 
                                                Padding="5,2" Margin="2"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </TabItem>
            <TabItem Header="System Environment Variables">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="5">
                        <Button Content="Add Variable" Command="{Binding AddVariableCommand}" 
                                IsEnabled="{Binding IsSystemReadOnly, Converter={StaticResource InverseBooleanConverter}}"
                                Margin="0,0,5,0" Padding="10,5"/>
                        <TextBlock Text="(Requires Administrator)" 
                                   Foreground="Orange" 
                                   VerticalAlignment="Center"
                                   Visibility="{Binding IsSystemReadOnly, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                    </StackPanel>
                    <DataGrid Grid.Row="1" ItemsSource="{Binding SystemVariables}" 
                              AutoGenerateColumns="False" 
                              CanUserAddRows="False"
                              CanUserDeleteRows="False"
                              SelectionMode="Single"
                              IsReadOnly="{Binding IsSystemReadOnly}"
                              GridLinesVisibility="Horizontal"
                              HeadersVisibility="Column"
                              Margin="5">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Name" Binding="{Binding Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                Width="*" IsReadOnly="{Binding IsReadOnly}"/>
                            <DataGridTemplateColumn Header="Value" Width="2*"
                                                    CellStyle="{StaticResource ValueColumnCellStyle}">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Border Padding="8,4" VerticalAlignment="Center">
                                            <TextBlock Text="{Binding Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                       TextWrapping="Wrap"
                                                       TextTrimming="CharacterEllipsis"
                                                       MaxHeight="100"
                                                       VerticalAlignment="Center"
                                                       IsEnabled="{Binding CanEdit}"
                                                       ToolTip="{Binding Value}"/>
                                        </Border>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                                <DataGridTemplateColumn.CellEditingTemplate>
                                    <DataTemplate>
                                        <TextBox Text="{Binding Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                 IsReadOnly="{Binding IsReadOnly}"
                                                 Padding="8,4"
                                                 VerticalContentAlignment="Center"
                                                 TextWrapping="Wrap"
                                                 AcceptsReturn="True"
                                                 MaxHeight="200"
                                                 VerticalScrollBarVisibility="Auto"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellEditingTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTemplateColumn Header="Actions" Width="Auto">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Button Content="Delete" Command="{Binding DeleteCommand}" 
                                                IsEnabled="{Binding CanEdit}"
                                                Padding="5,2" Margin="2"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </TabItem>
        </TabControl>

        <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Right" Margin="10">
            <Button Content="Save" Command="{Binding SaveCommand}" 
                    IsEnabled="{Binding HasPendingChanges}"
                    Margin="0,0,5,0" Padding="15,5"/>
            <Button Content="Cancel" Command="{Binding CancelCommand}" 
                    IsEnabled="{Binding HasPendingChanges}"
                    Padding="15,5"/>
        </StackPanel>
    </Grid>
</Window>
